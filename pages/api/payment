import type { NextApiRequest, NextApiResponse } from "next";
import { createClient } from "@supabase/supabase-js";

/* ================= CLIENT ================= */
const supabase = createClient(
  process.env.SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY!
);

/* ================= WHATSAPP SENDER (PLACEHOLDER LATER TO ADD CODE NOW STILL FAKE SENDER) ================= */
/*
  Replace this with:
  - Twilio
  - Meta WhatsApp Cloud API
  - 360dialog
*/
async function sendWhatsAppMessage(
  phone: string,
  message: string
) {
  console.log("ğŸ“¤ WhatsApp â†’", phone);
  console.log(message);
}

/* ================= API HANDLER ================= */
export default async function handler(
  req: NextApiRequest,
  res: NextApiResponse
) {
  if (req.method !== "POST") {
    return res.status(405).end();
  }

  try {
    /* ================= PARSE WEBHOOK ================= */
    const body =
      typeof req.body === "string" ? JSON.parse(req.body) : req.body;

    const {
      ticket_id,
      payment_id,
      status,
      amount,
      currency
    } = body;

    if (!ticket_id || !payment_id || status !== "paid") {
      return res.status(400).json({ error: "Invalid webhook payload" });
    }

    /* ================= LOAD TICKET ================= */
    const { data: ticket, error: ticketError } = await supabase
      .from("tickets")
      .select(
        "id, condo_id, phone_number, language, status"
      )
      .eq("id", ticket_id)
      .maybeSingle();

    if (ticketError || !ticket) {
      return res.status(404).json({ error: "Ticket not found" });
    }

    const lang = ticket.language ?? "en";

    /* ================= IDEMPOTENCY CHECK (FOR PROTECTION AGAINST WEBHOOK RETRY) ================= */
const refno = body.refno;
const ticketId = body.order_id;

const { data: existingPayment } = await supabase
  .from("payments")
  .select("id")
  .eq("gateway_payment_id", refno)
  .eq("status", "paid")
  .maybeSingle();

if (existingPayment) {
  return res.status(200).json({ ok: true, duplicate: true });
}

    /* ================= INSERT PAYMENT ================= */
await supabase.from("payments").insert({
  ticket_id: ticketId,
  gateway_payment_id: refno,
  amount: Number(body.amount),
  status: "paid",
  provider: "toyyibpay",
  payment_type: "diagnosis_fee",
  created_at: new Date()
});

if (body.status_id !== "1") {
  return res.status(200).json({ ignored: true });
}

    /* ================= UPDATE TICKET ================= */
    await supabase
      .from("tickets")
      .update({
        status: "paid",
        paid_at: new Date()
      })
      .eq("id", ticket.id);

    /* ================= ASSIGN CONTRACTOR (SIMPLE) ================= */
    const { data: contractor } = await supabase
      .from("contractors")
      .select("id")
      .eq("condo_id", ticket.condo_id)
      .eq("active", true)
      .order("rating", { ascending: false })
      .limit(1)
      .maybeSingle();

    if (contractor) {
      await supabase
        .from("tickets")
        .update({ contractor_id: contractor.id })
        .eq("id", ticket.id);
    }

    /* ================= BUILD WHATSAPP MESSAGE ================= */
    let message = "";

    switch (lang) {
      case "ms":
        message = `âœ… Pembayaran telah disahkan.
Kontraktor telah ditugaskan dan akan menghubungi anda.

Terima kasih.`;
        break;

      case "zh":
        message = `âœ… ä»˜æ¬¾å·²ç¡®è®¤ã€‚
å·²åˆ†é…æ‰¿åŒ…å•†ï¼Œç¨åå°†ä¸æ‚¨è”ç³»ã€‚

è°¢è°¢ã€‚`;
        break;

      case "ta":
        message = `âœ… à®•à®Ÿà¯à®Ÿà®£à®®à¯ à®‰à®±à¯à®¤à®¿à®ªà¯à®ªà®Ÿà¯à®¤à¯à®¤à®ªà¯à®ªà®Ÿà¯à®Ÿà®¤à¯.
à®’à®ªà¯à®ªà®¨à¯à®¤à®¤à®¾à®°à®°à¯ à®¨à®¿à®¯à®®à®¿à®•à¯à®•à®ªà¯à®ªà®Ÿà¯à®Ÿà¯ à®‰à®™à¯à®•à®³à¯ˆ à®¤à¯Šà®Ÿà®°à¯à®ªà¯à®•à¯Šà®³à¯à®µà®¾à®°à¯.

à®¨à®©à¯à®±à®¿.`;
        break;

      default:
        message = `âœ… Payment confirmed.
A contractor has been assigned and will contact you.

Thank you.`;
    }

    /* ================= SEND WHATSAPP ================= */
    await sendWhatsAppMessage(ticket.phone_number, message);

    /* ================= RESET CONVERSATION SESSION ================= */
    await supabase
      .from("conversation_sessions")
      .update({
        state: "intake",
        current_ticket_id: null,
        updated_at: new Date()
      })
      .eq("condo_id", ticket.condo_id)
      .eq("phone_number", ticket.phone_number);

    return res.status(200).json({ ok: true });
  } catch (err: any) {
    console.error("ğŸ”¥ PAYMENT WEBHOOK ERROR:", err);
    return res.status(500).json({
      error: "Internal Server Error",
      detail: err.message
    });
  }
}
